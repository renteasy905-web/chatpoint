<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Screen Sharer - Share Phone/PC Screen</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      color: white;
      font-family: sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    video {
      width: 100vw;
      height: 100vh;
      object-fit: contain;
      background: black;
    }
    button {
      padding: 16px 32px;
      font-size: 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      margin: 20px;
    }
    #status {
      text-align: center;
      font-size: 18px;
      padding: 0 20px;
    }
    #peerId {
      font-size: 28px;
      font-weight: bold;
      color: #0f0;
      margin: 10px;
    }
  </style>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
</head>
<body>

  <video id="preview" autoplay playsinline muted></video>

  <div id="status">Tap below to start sharing your screen</div>
  <button id="startBtn">Start Screen Share</button>
  <div>Sharing Code (give to viewer):</div>
  <div id="peerId">â€” waiting â€”</div>

  <script>
    const video = document.getElementById('preview');
    const startBtn = document.getElementById('startBtn');
    const status = document.getElementById('status');
    const peerIdDiv = document.getElementById('peerId');

    let peer;
    let screenStream;
    let currentCall;

    // Use random short ID or let PeerJS generate one
    peer = new Peer();  // PeerJS will generate ID automatically

    peer.on('open', (id) => {
      peerIdDiv.textContent = id;
      status.textContent = 'Ready. Share this code with the viewer:';
    });

    peer.on('error', (err) => {
      status.textContent = 'Error: ' + err.message;
      console.error(err);
    });

    startBtn.onclick = async () => {
      startBtn.disabled = true;
      status.textContent = 'Requesting screen permission...';

      try {
        screenStream = await navigator.mediaDevices.getDisplayMedia({
          video: { cursor: "always" },
          audio: false
        });

        video.srcObject = screenStream;
        status.textContent = 'ðŸ”´ Sharing live â€“ do NOT close this tab';

        // Handle incoming calls from viewers
        peer.on('call', (call) => {
          call.answer(screenStream);  // Send the screen stream back
          currentCall = call;

          call.on('close', () => {
            status.textContent += '\nViewer disconnected.';
          });

          call.on('error', (err) => {
            console.error('Call error:', err);
          });
        });

        // When user stops sharing in browser UI
        screenStream.getVideoTracks()[0].addEventListener('ended', () => {
          status.textContent = 'You stopped sharing. Refresh to start again.';
          startBtn.disabled = false;
          video.srcObject = null;
          if (currentCall) currentCall.close();
        });

      } catch (err) {
        status.textContent = 'Permission denied / error: ' + err.message;
        startBtn.disabled = false;
        console.error(err);
      }
    };
  </script>
</body>
</html>
