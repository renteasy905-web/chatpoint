<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <meta name="title" content="My Cart ‚Äî ChatPoint">
  <title>My Cart ‚Äî ChatPoint</title>
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#2563eb">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-light: #64748b;
      --border: #e2e8f0;
      --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
      --radius: 12px;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { margin: 0; padding: 0; height: 100%; font-family: system-ui, -apple-system, 'Segoe UI', Arial, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; overscroll-behavior: none; touch-action: manipulation; }
    body { min-height: 100dvh; }
    .header { position: sticky; top: 0; background: var(--card-bg); padding: 16px 20px; box-shadow: var(--shadow-sm); display: flex; align-items: center; gap: 16px; z-index: 10; }
    .back { font-size: 32px; cursor: pointer; color: var(--primary); font-weight: 300; }
    .title { font-size: 22px; font-weight: 600; flex: 1; }
    .container { padding: 24px 16px; max-width: 640px; margin: 0 auto; padding-bottom: 120px; }
    .cart-items { display: grid; gap: 20px; margin-bottom: 32px; }
    .cart-item { background: var(--card-bg); border-radius: var(--radius); padding: 20px; display: flex; align-items: center; gap: 20px; box-shadow: var(--shadow-sm); transition: box-shadow 0.3s; }
    .cart-item:hover { box-shadow: var(--shadow); }
    .cart-item img { width: 90px; height: 90px; object-fit: cover; border-radius: var(--radius); background: #f1f5f9; }
    .item-details { flex: 1; }
    .item-name { font-weight: 600; font-size: 18px; margin-bottom: 6px; }
    .item-price { color: var(--primary); font-weight: bold; font-size: 17px; }
    .quantity-controls { display: flex; align-items: center; gap: 16px; margin-top: 12px; }
    .qty-btn { width: 40px; height: 40px; background: #f1f5f9; border: none; border-radius: 50%; font-size: 20px; font-weight: bold; cursor: pointer; color: var(--text); transition: background 0.2s; }
    .qty-btn:hover { background: #e2e8f0; }
    .qty-btn:active { transform: scale(0.95); }
    .quantity { font-size: 18px; font-weight: 600; min-width: 40px; text-align: center; }
    .remove-btn { color: var(--danger); font-size: 28px; cursor: pointer; font-weight: 300; }
    .total-section { background: var(--card-bg); padding: 24px; border-radius: var(--radius); box-shadow: var(--shadow-sm); margin-bottom: 32px; }
    .total-row { display: flex; justify-content: space-between; font-size: 17px; margin-bottom: 16px; }
    .grand-total { font-size: 22px; font-weight: bold; color: var(--primary); padding-top: 12px; border-top: 2px solid var(--border); }

    /* Updated: Coupon area with Apply button below input */
    .coupon-area {
      margin-bottom: 20px;
    }
    .coupon-input-wrapper {
      margin-bottom: 12px;
    }
    .coupon-input {
      width: 100%;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 16px;
    }
    .coupon-btn {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
    }
    .applied-coupon-tag {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
      padding: 12px 16px;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 16px;
    }
    .remove-coupon-btn {
      background: none;
      border: none;
      color: var(--success);
      font-size: 20px;
      cursor: pointer;
      margin-left: 12px;
    }

    .coupon-msg { margin-top: 8px; font-size: 14px; text-align: center; }
    .success-msg { color: var(--success); }
    .error-msg { color: var(--danger); }
    .min-order-note { font-size: 15px; color: var(--danger); text-align: center; margin: 16px 0 8px; font-weight: 500; }
    .checkout-form { background: var(--card-bg); padding: 24px; border-radius: var(--radius); box-shadow: var(--shadow-sm); }
    .checkout-form input, .checkout-form textarea { width: 100%; padding: 16px; margin: 12px 0; border: 1px solid var(--border); border-radius: var(--radius); font-size: 16px; box-sizing: border-box; }
    .checkout-form input:focus, .checkout-form textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15); }
    .checkout-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 18px; font-size: 18px; font-weight: 600; border-radius: var(--radius); cursor: pointer; margin-top: 16px; box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25); transition: all 0.3s; }
    .checkout-btn:hover { background: var(--primary-dark); transform: translateY(-2px); }
    .checkout-btn:disabled { background: #94a3b8; cursor: not-allowed; box-shadow: none; }
    .empty-cart, .login-required { text-align: center; padding: 80px 20px; color: var(--text-light); font-size: 19px; }
    .empty-cart a, .login-required a { color: var(--primary); text-decoration: none; font-weight: 600; font-size: 18px; }
  </style>
</head>
<body>
  <div class="header">
    <div class="back" onclick="history.back()">‚Üê</div>
    <div class="title">My Cart</div>
  </div>
  <div class="container">
    <div id="loginRequired" class="login-required" style="display:none;">
      <p>You need to login to view your cart</p>
      <p><a href="login.html">Login Now ‚Üí</a></p>
    </div>
    <div id="cartContent">
      <div id="cartItems" class="cart-items"></div>
      <div id="emptyCart" class="empty-cart" style="display:none;">
        <p>Your cart is empty</p>
        <p><a href="index.html">Continue Shopping ‚Üí</a></p>
      </div>
      <div id="totalSection" class="total-section" style="display:none;">
        <div class="total-row">
          <span>Subtotal</span>
          <span id="subtotal">‚Çπ0</span>
        </div>

        <!-- Updated: Apply button below the input field -->
        <div class="coupon-area">
          <div id="couponInputGroup">
            <div class="coupon-input-wrapper">
              <input type="text" id="couponCode" class="coupon-input" placeholder="Enter coupon code">
            </div>
            <button class="coupon-btn" onclick="applyCoupon()">Apply Coupon</button>
          </div>
          <div id="appliedCouponTag" class="applied-coupon-tag" style="display:none;">
            <span id="appliedCouponText"></span>
            <button class="remove-coupon-btn" onclick="removeCoupon()">‚úï</button>
          </div>
        </div>

        <div id="couponMsg" class="coupon-msg"></div>

        <div class="total-row grand-total">
          <span>Grand Total</span>
          <span id="grandTotal">‚Çπ0</span>
        </div>
        <div class="min-order-note" id="minOrderNote"></div>
        <div class="checkout-form">
          <input type="text" id="name" placeholder="Your Full Name" required>
          <input type="tel" id="phone" placeholder="Phone Number" required>
          <textarea id="address" placeholder="Full Delivery Address (with landmark)" rows="4" required></textarea>
          <button class="checkout-btn" id="checkoutBtn" onclick="placeOrder()" disabled>Place Order</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const MIN_ORDER = 300;
    const FIXED_DELIVERY = 20;
    const COUPONS = {
      "me0204": { type: "percent", value: 5, maxDiscount: null, minAmount: 500, category: "all" },
      "dec10": { type: "percent", value: 10, maxDiscount: 10, minAmount: 0, category: "fmcg" },
      "welcome104": { type: "percent", value: 2, maxDiscount: 8, minAmount: 299, category: "all" }
    };
    const FMCG_ITEMS = ["shampoo", "soap", "oil", "rice", "dal", "atta", "toothpaste", "detergent"];

    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    const user = JSON.parse(localStorage.getItem('chatpoint_user') || null);
    let appliedCoupon = null;

    if (!user) {
      document.getElementById('cartContent').style.display = 'none';
      document.getElementById('loginRequired').style.display = 'block';
    } else {
      document.getElementById('name').value = user.name || '';
      document.getElementById('phone').value = user.phone || '';
      renderCart();
    }

    function renderCart() {
      const cartItemsDiv = document.getElementById('cartItems');
      const emptyCartDiv = document.getElementById('emptyCart');
      const totalSection = document.getElementById('totalSection');

      if (cart.length === 0) {
        emptyCartDiv.style.display = 'block';
        totalSection.style.display = 'none';
        return;
      }

      emptyCartDiv.style.display = 'none';
      totalSection.style.display = 'block';

      cartItemsDiv.innerHTML = cart.map((item, index) => `
        <div class="cart-item">
          <img src="${item.img}" alt="${item.name}" onerror="this.src='https://placehold.co/90x90?text=No+Image'">
          <div class="item-details">
            <div class="item-name">${item.name}</div>
            <div class="item-price">‚Çπ${item.price} each</div>
            <div class="quantity-controls">
              <button class="qty-btn" onclick="updateQty(${index}, -1)">‚àí</button>
              <span class="quantity">${item.qty}</span>
              <button class="qty-btn" onclick="updateQty(${index}, 1)">+</button>
            </div>
          </div>
          <div class="remove-btn" onclick="removeItem(${index})">√ó</div>
        </div>
      `).join('');

      calculateTotal();
      updateCouponUI();
    }

    function updateQty(index, change) {
      cart[index].qty += change;
      if (cart[index].qty <= 0) cart.splice(index, 1);
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
    }

    function removeItem(index) {
      if (confirm("Remove this item from cart?")) {
        cart.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
      }
    }

    function updateCouponUI() {
      const inputGroup = document.getElementById('couponInputGroup');
      const tag = document.getElementById('appliedCouponTag');
      const tagText = document.getElementById('appliedCouponText');

      if (appliedCoupon) {
        inputGroup.style.display = 'none';
        tag.style.display = 'flex';
        tagText.textContent = `Coupon "${appliedCoupon.code.toUpperCase()}" applied!`;
      } else {
        inputGroup.style.display = 'block';
        tag.style.display = 'none';
      }
    }

    function removeCoupon() {
      appliedCoupon = null;
      document.getElementById('couponMsg').textContent = '';
      document.getElementById('couponMsg').className = 'coupon-msg';
      document.getElementById('couponCode').value = '';
      calculateTotal();
      updateCouponUI();
    }

    function applyCoupon() {
      if (appliedCoupon) return;

      const code = document.getElementById('couponCode').value.trim().toLowerCase();
      const msgDiv = document.getElementById('couponMsg');
      msgDiv.textContent = '';
      msgDiv.className = 'coupon-msg';

      if (!code) {
        msgDiv.textContent = 'Please enter a coupon code';
        msgDiv.classList.add('error-msg');
        return;
      }

      if (!COUPONS[code]) {
        msgDiv.textContent = 'Invalid coupon code';
        msgDiv.classList.add('error-msg');
        return;
      }

      const coupon = COUPONS[code];
      const subtotal = cart.reduce((sum, item) => sum + item.price * item.qty, 0);

      if (subtotal < coupon.minAmount) {
        msgDiv.textContent = `Minimum ‚Çπ${coupon.minAmount} required for this coupon`;
        msgDiv.classList.add('error-msg');
        return;
      }

      if (coupon.category === "fmcg") {
        const fmcgTotal = cart
          .filter(item => FMCG_ITEMS.some(f => item.name.toLowerCase().includes(f)))
          .reduce((sum, item) => sum + item.price * item.qty, 0);
        if (fmcgTotal === 0) {
          msgDiv.textContent = 'No FMCG items in cart';
          msgDiv.classList.add('error-msg');
          return;
        }
      }

      appliedCoupon = { code, ...coupon };
      msgDiv.textContent = `Coupon applied successfully!`;
      msgDiv.classList.add('success-msg');
      calculateTotal();
      updateCouponUI();
    }

    function calculateTotal() {
      const subtotal = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
      let discount = 0;
      if (appliedCoupon) {
        let applicableAmount = subtotal;
        if (appliedCoupon.category === "fmcg") {
          applicableAmount = cart
            .filter(item => FMCG_ITEMS.some(f => item.name.toLowerCase().includes(f)))
            .reduce((sum, item) => sum + item.price * item.qty, 0);
        }
        discount = (applicableAmount * appliedCoupon.value) / 100;
        if (appliedCoupon.maxDiscount) {
          discount = Math.min(discount, appliedCoupon.maxDiscount);
        }
      }
      const finalAmount = Math.round(subtotal - discount + FIXED_DELIVERY);

      document.getElementById('subtotal').textContent = `‚Çπ${subtotal}`;
      document.getElementById('grandTotal').textContent = `‚Çπ${finalAmount}`;

      const checkoutBtn = document.getElementById('checkoutBtn');
      const minOrderNote = document.getElementById('minOrderNote');

      if (subtotal >= MIN_ORDER) {
        checkoutBtn.disabled = false;
        minOrderNote.style.display = 'none';
      } else {
        checkoutBtn.disabled = true;
        minOrderNote.style.display = 'block';
        minOrderNote.textContent = `Add ‚Çπ${MIN_ORDER - subtotal} more to reach minimum order of ‚Çπ${MIN_ORDER}`;
      }
    }

    async function placeOrder() {
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      if (!name || !phone || !address) return alert("Please fill in all the details");
      const subtotal = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
      if (subtotal < MIN_ORDER) return alert(`Minimum order amount is ‚Çπ${MIN_ORDER}`);

      let discount = 0;
      if (appliedCoupon) {
        let applicableAmount = subtotal;
        if (appliedCoupon.category === "fmcg") {
          applicableAmount = cart.filter(item => FMCG_ITEMS.some(f => item.name.toLowerCase().includes(f)))
            .reduce((sum, item) => sum + item.price * item.qty, 0);
        }
        discount = Math.min((applicableAmount * appliedCoupon.value) / 100, appliedCoupon.maxDiscount || Infinity);
      }
      const grandTotal = Math.round(subtotal - discount + FIXED_DELIVERY);

      const cartObj = { "ChatPoint": {} };
      cart.forEach(item => cartObj["ChatPoint"][item.name] = { price: item.price, qty: item.qty });

      const body = {
        name, phone, address1: address, grandTotal, cart: cartObj,
        coupon: appliedCoupon ? appliedCoupon.code.toUpperCase() : null,
        discountAmount: discount,
        userId: user?._id || null,
        customer_name: user?.name || name,
        customer_phone: user?.phone || phone
      };

      try {
        const res = await fetch("/api/order", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
        const data = await res.json();
        if (data.success) {
          alert("Order placed successfully! üéâ");
          localStorage.removeItem('cart');
          cart = [];
          appliedCoupon = null;
          renderCart();
          window.location.href = 'tracking.html';
        } else {
          alert("Order failed: " + (data.message || "Please try again"));
        }
      } catch (err) {
        alert("Network error. Please check your connection.");
      }
    }

    window.addEventListener('pageshow', (e) => {
      if (e.persisted) location.reload();
    });
  </script>
</body>
</html>
