<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Tracking | ChatPoint</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --primary: #ff4500;
      --text: #333;
      --bg: #f8f9fa;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .container { max-width: 480px; margin: 0 auto; }

    /* Header like Zomato */
    .header {
      background: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .back-btn {
      font-size: 24px;
      cursor: pointer;
      color: var(--text);
    }
    .title { font-size: 18px; font-weight: bold; }

    /* Map Section */
    .map-container {
      position: relative;
      height: 400px;
      background: #e0e0e0;
      overflow: hidden;
      margin: 16px 0;
    }
    .map-bg {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: brightness(0.9);
    }

    /* Dotted Path */
    .path {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
    }
    .path-svg {
      width: 100%;
      height: 100%;
    }
    .dotted-line {
      stroke: var(--primary);
      stroke-width: 4;
      fill: none;
      stroke-dasharray: 8,8;
    }

    /* Pins */
    .pin {
      position: absolute;
      font-size: 32px;
      color: var(--primary);
      transform: translate(-50%, -100%);
    }
    .store-pin { left: 15%; top: 70%; }
    .customer-pin { left: 80%; top: 20%; }

    /* Delivery Bike */
    .bike {
      position: absolute;
      font-size: 28px;
      color: black;
      transform: translate(-50%, -50%);
      transition: all 1s ease-in-out;
      z-index: 5;
    }

    /* Status Info */
    .status-box {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    .status-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 12px;
    }
    .eta {
      font-size: 16px;
      color: var(--primary);
      font-weight: bold;
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      position: relative;
    }
    .step {
      text-align: center;
      flex: 1;
      position: relative;
    }
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ddd;
      margin: 0 auto 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }
    .step.active .step-circle {
      background: var(--primary);
    }
    .step-label {
      font-size: 12px;
      color: #666;
    }
    .step.active .step-label {
      color: var(--primary);
      font-weight: bold;
    }

    .loader {
      text-align: center;
      padding: 40px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="back-btn" onclick="history.back()">‚Üê</div>
      <div class="title">Order Tracking</div>
      <div></div>
    </div>

    <!-- Loading -->
    <div id="loading" class="loader">
      <i class="fas fa-spinner fa-spin fa-3x"></i>
      <p>Loading tracking info...</p>
    </div>

    <!-- Main Tracking Content -->
    <div id="trackingContent" style="display:none;">
      <div class="map-container">
        <!-- Dummy Map Image (replace with your own or use Mapbox/Leaflet later) -->
        <img src="https://images.unsplash.com/photo-1569336415965-7d80c2e3ff2a?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80" alt="Map" class="map-bg">

        <!-- Dotted Path SVG -->
        <div class="path">
          <svg class="path-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
            <path class="dotted-line" d="M15 70 Q 30 50, 50 45 T 80 20" />
          </svg>
        </div>

        <!-- Store Pin -->
        <div class="pin store-pin">
          <i class="fas fa-store"></i>
        </div>

        <!-- Customer Pin -->
        <div class="pin customer-pin">
          <i class="fas fa-map-marker-alt"></i>
        </div>

        <!-- Delivery Partner Bike -->
        <div class="bike" id="bikeIcon">
          <i class="fas fa-motorcycle"></i>
        </div>
      </div>

      <!-- Status Box -->
      <div class="status-box">
        <div class="status-title" id="statusTitle">Your order is being prepared</div>
        <div class="eta" id="etaText">Arriving in ~20 minutes</div>

        <!-- Progress Steps -->
        <div class="progress-steps">
          <div class="step" data-step="0">
            <div class="step-circle">1</div>
            <div class="step-label">Order Confirmed</div>
          </div>
          <div class="step" data-step="1">
            <div class="step-circle">2</div>
            <div class="step-label">Picked Up</div>
          </div>
          <div class="step" data-step="2">
            <div class="step-circle">3</div>
            <div class="step-label">On the Way</div>
          </div>
          <div class="step" data-step="3">
            <div class="step-circle">4</div>
            <div class="step-label">Delivered</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('orderId');

    if (!orderId) {
      document.getElementById('loading').innerHTML = '<p>Invalid order ID.</p>';
    } else {
      fetchOrder();
      setInterval(fetchOrder, 8000); // Refresh every 8 seconds
    }

    async function fetchOrder() {
      try {
        const res = await fetch(`${API_BASE}/api/order/${orderId}?t=${Date.now()}`);
        const data = await res.json();

        if (data.success && data.order) {
          updateTracking(data.order);
        } else {
          document.getElementById('loading').innerHTML = '<p>Order not found.</p>';
        }
      } catch (err) {
        console.error(err);
      }
    }

    function updateTracking(order) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('trackingContent').style.display = 'block';

      const progress = order.progress || 0; // 0 to 4 from delivery portal buttons

      const bike = document.getElementById('bikeIcon');
      const statusTitle = document.getElementById('statusTitle');
      const etaText = document.getElementById('etaText');

      // Move bike along the path (approximate positions)
      const positions = [
        { left: '15%', top: '70%' },   // At store
        { left: '35%', top: '55%' },
        { left: '55%', top: '45%' },
        { left: '70%', top: '30%' },
        { left: '80%', top: '20%' }    // At customer
      ];

      if (progress >= 0 && progress <= 4) {
        const pos = positions[progress];
        bike.style.left = pos.left;
        bike.style.top = pos.top;
      }

      // Update steps
      document.querySelectorAll('.step').forEach((step, i) => {
        if (i <= progress) {
          step.classList.add('active');
        } else {
          step.classList.remove('active');
        }
      });

      // Status messages
      const messages = [
        "Your order has been confirmed and is being prepared",
        "Delivery partner has picked up your order",
        "Your order is on the way",
        "Almost there! Your order is very close",
        "Delivered! Enjoy your meal ü•≥"
      ];
      const etas = [
        "~25-30 minutes",
        "~20-25 minutes",
        "~10-15 minutes",
        "~5 minutes",
        "Delivered just now!"
      ];

      statusTitle.textContent = messages[progress] || messages[0];
      etaText.textContent = etas[progress] || etas[0];

      // If delivered, change bike to checkmark
      if (progress === 4) {
        bike.innerHTML = '<i class="fas fa-check-circle" style="font-size:36px;color:#28a745;"></i>';
      }
    }
  </script>
</body>
</html>
