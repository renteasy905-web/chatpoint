<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Order Tracking | ChatPoint</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --primary: #ff4500;
      --text: #333;
      --bg: #f8f9fa;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .container { max-width: 480px; margin: 0 auto; padding: 1rem; }

    .header {
      background: white;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .back-btn {
      font-size: 24px;
      cursor: pointer;
      color: var(--text);
    }
    .title { font-size: 18px; font-weight: bold; }

    .order-card {
      background: white;
      border-radius: 12px;
      margin: 16px 0;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    .order-header {
      padding: 16px;
      background: #fff;
      border-bottom: 1px solid #eee;
    }
    .order-id {
      font-weight: bold;
      font-size: 1.1rem;
    }
    .order-status {
      font-size: 0.9rem;
      color: var(--primary);
      margin-top: 4px;
    }

    .map-container {
      position: relative;
      height: 300px;
      background: #e0e0e0;
      overflow: hidden;
    }
    .map-bg {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: brightness(0.9);
    }
    .path {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none;
    }
    .path-svg {
      width: 100%;
      height: 100%;
    }
    .dotted-line {
      stroke: var(--primary);
      stroke-width: 4;
      fill: none;
      stroke-dasharray: 8,8;
    }
    .pin {
      position: absolute;
      font-size: 32px;
      color: var(--primary);
      transform: translate(-50%, -100%);
    }
    .store-pin { left: 15%; top: 70%; }
    .customer-pin { left: 80%; top: 20%; }
    .bike {
      position: absolute;
      font-size: 28px;
      color: black;
      transform: translate(-50%, -50%);
      transition: all 1s ease-in-out;
      z-index: 5;
    }

    .status-box {
      padding: 20px;
      text-align: center;
    }
    .status-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .eta {
      font-size: 16px;
      color: var(--primary);
      font-weight: bold;
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      padding: 0 20px 20px;
    }
    .step {
      text-align: center;
      flex: 1;
    }
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ddd;
      margin: 0 auto 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    .step.active .step-circle {
      background: var(--primary);
    }
    .step-label {
      font-size: 12px;
      color: #666;
    }
    .step.active .step-label {
      color: var(--primary);
      font-weight: bold;
    }

    .no-orders {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      font-size: 1.1rem;
    }
    .loader {
      text-align: center;
      padding: 40px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="back-btn" onclick="history.back()">‚Üê</div>
      <div class="title">My Order Tracking</div>
      <div></div>
    </div>

    <div id="loading" class="loader">
      <i class="fas fa-spinner fa-spin fa-3x"></i>
      <p>Loading your orders...</p>
    </div>

    <div id="noLogin" class="no-orders" style="display:none;">
      <p>You need to login to track your orders</p>
      <p><a href="login.html" style="color:var(--primary);font-weight:bold;">Login Now ‚Üí</a></p>
    </div>

    <div id="noOrders" class="no-orders" style="display:none;">
      <p>No active orders right now</p>
      <p>Place an order to track it here!</p>
    </div>

    <div id="ordersList"></div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    const loggedUser = JSON.parse(localStorage.getItem('chatpoint_user') || 'null');

    if (!loggedUser) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('noLogin').style.display = 'block';
    } else {
      fetchUserOrders();
      setInterval(fetchUserOrders, 10000); // Refresh every 10 seconds
    }

    async function fetchUserOrders() {
      try {
        const res = await fetch(`${API_BASE}/api/my-orders`, {
          headers: { 'x-user-id': loggedUser._id }
        });
        const data = await res.json();

        if (data.success && data.orders && data.orders.length > 0) {
          // Filter only pending + confirmed (active)
          const activeOrders = data.orders.filter(o => o.status === 'pending' || o.status === 'confirmed');
          if (activeOrders.length === 0) {
            showNoOrders();
          } else {
            renderOrders(activeOrders);
          }
        } else {
          showNoOrders();
        }
      } catch (err) {
        console.error(err);
        document.getElementById('loading').innerHTML = '<p>Error loading orders. Retrying...</p>';
      }
    }

    function showNoOrders() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('noOrders').style.display = 'block';
    }

    function renderOrders(orders) {
      document.getElementById('loading').style.display = 'none';

      const list = document.getElementById('ordersList');
      list.innerHTML = orders.map(order => {
        const progress = order.progress || 0;

        const positions = [
          { left: '15%', top: '70%' },   // 0: at store
          { left: '35%', top: '55%' },   // 1
          { left: '55%', top: '45%' },   // 2
          { left: '70%', top: '30%' },   // 3
          { left: '80%', top: '20%' }    // 4: delivered
        ];
        const pos = positions[Math.min(progress, 4)];

        const messages = [
          "Order confirmed - being prepared",
          "Picked up from store",
          "On the way",
          "Almost there!",
          "Delivered! Enjoy ü•≥"
        ];
        const etas = ["~30 min", "~25 min", "~15 min", "~5 min", "Just now"];

        let bikeIcon = '<i class="fas fa-motorcycle"></i>';
        if (progress === 4) bikeIcon = '<i class="fas fa-check-circle" style="font-size:36px;color:#28a745;"></i>';

        return `
          <div class="order-card">
            <div class="order-header">
              <div class="order-id">Order #${order._id.slice(-6)}</div>
              <div class="order-status">${order.status === 'pending' ? 'Pending Confirmation' : 'Out for Delivery'}</div>
            </div>

            <div class="map-container">
              <img src="https://images.unsplash.com/photo-1569336415965-7d80c2e3ff2a?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80" alt="Map" class="map-bg">

              <div class="path">
                <svg class="path-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
                  <path class="dotted-line" d="M15 70 Q 30 50, 50 45 T 80 20" />
                </svg>
              </div>

              <div class="pin store-pin"><i class="fas fa-store"></i></div>
              <div class="pin customer-pin"><i class="fas fa-map-marker-alt"></i></div>

              <div class="bike" style="left:${pos.left};top:${pos.top};">
                ${bikeIcon}
              </div>
            </div>

            <div class="status-box">
              <div class="status-title">${messages[progress] || messages[0]}</div>
              <div class="eta">${etas[progress] || etas[0]}</div>

              <div class="progress-steps">
                ${[1,2,3,4].map(num => `
                  <div class="step ${progress >= num ? 'active' : ''}">
                    <div class="step-circle">${num}</div>
                    <div class="step-label">${['Prepared','Picked','On Way','Near','Delivered'][num-1]}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
  </script>
</body>
</html>
