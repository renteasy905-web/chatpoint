<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - Grocery Items</title>
    <style>
        body { font-family: Arial, sans-serif; background:#f0f0f0; margin:0; padding:20px; }
        .container { max-width:900px; margin:auto; background:white; padding:30px; border-radius:12px; box-shadow:0 0 20px rgba(0,0,0,0.1); }
        h1 { text-align:center; color:#4CAF50; margin-bottom:20px; }
        form { display:grid; gap:18px; background:#f9f9f9; padding:25px; border-radius:12px; margin-bottom:40px; }
        label { font-weight:bold; color:#333; }
        input, select, button { padding:14px; font-size:16px; border-radius:8px; border:1px solid #ccc; }
        select { background:white; }
        button { background:#4CAF50; color:white; border:none; cursor:pointer; font-weight:bold; }
        button:hover { background:#45a049; }
        .new-category-input { display:none; } /* Hidden until "Add New" selected */
        .items-section h2 { margin-top:40px; }
        .items-list { display:grid; gap:20px; margin-top:20px; }
        .item-card { background:#f9f9f9; padding:20px; border-radius:12px; display:flex; gap:20px; box-shadow:0 2px 10px rgba(0,0,0,0.05); }
        .item-card img { width:100px; height:100px; object-fit:cover; border-radius:10px; }
        .item-info { flex:1; }
        .item-info strong { font-size:18px; display:block; margin-bottom:5px; }
        .price-input { width:120px; padding:10px; margin-top:10px; }
        .actions button { padding:10px 16px; margin-right:8px; border:none; border-radius:6px; cursor:pointer; }
        .actions .update { background:#4CAF50; color:white; }
        .actions .delete { background:#ff4444; color:white; }
        .no-items { text-align:center; color:#999; padding:40px; font-size:18px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Admin Portal</h1>

        <label>Admin Password:</label>
        <input type="password" id="adminPass" placeholder="Enter password (Brand)" required>

        <form id="addForm">
            <label>Category:</label>
            <select id="categorySelect" required>
                <option value="">Loading categories...</option>
            </select>
            <input type="text" id="newCategory" class="new-category-input" placeholder="Type new category name">

            <label>Item Name:</label>
            <input type="text" id="name" placeholder="e.g. Fresh Apple 1kg" required>

            <label>Price (â‚¹):</label>
            <input type="number" id="price" placeholder="180" min="1" required>

            <label>Item Image:</label>
            <input type="file" id="image" accept="image/*" required>

            <button type="submit">Add Item</button>
        </form>

        <div class="items-section">
            <h2>Manage Items</h2>
            <label>Select Category:</label>
            <select id="viewCategory" onchange="loadItems(this.value)"></select>
            <div id="itemsList" class="items-list">
                <p class="no-items">Select a category above to view items</p>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_PASS = "Brand"; // Your password
        let categories = [];

        async function loadCategories() {
            try {
                const res = await fetch("/api/categories");
                const data = await res.json();
                if (data.success) {
                    categories = data.categories.sort();
                    const addSelect = document.getElementById("categorySelect");
                    const viewSelect = document.getElementById("viewCategory");

                    // For add form
                    addSelect.innerHTML = `
                        <option value="">-- Select Existing or Add New --</option>
                        ${categories.map(c => `<option value="${c}">${c}</option>`).join("")}
                        <option value="__new__">+ Add New Category</option>
                    `;

                    // For view/manage
                    viewSelect.innerHTML = `
                        <option value="">-- Choose Category --</option>
                        ${categories.map(c => `<option value="${c}">${c}</option>`).join("")}
                    `;

                    if (categories.length > 0) {
                        viewSelect.value = categories[0];
                        loadItems(categories[0]);
                    }
                }
            } catch (err) {
                console.error("Failed to load categories:", err);
                document.getElementById("categorySelect").innerHTML = "<option>Error loading</option>";
            }
        }

        // Show/hide new category input
        document.getElementById("categorySelect").addEventListener("change", function() {
            const newInput = document.getElementById("newCategory");
            if (this.value === "__new__") {
                newInput.style.display = "block";
                newInput.required = true;
                newInput.focus();
            } else {
                newInput.style.display = "none";
                newInput.required = false;
            }
        });

        // Get final category value for submit
        function getSelectedCategory() {
            const select = document.getElementById("categorySelect");
            if (select.value === "__new__") {
                return document.getElementById("newCategory").value.trim();
            }
            return select.value;
        }

        document.getElementById("addForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            const pass = document.getElementById("adminPass").value;
            if (pass !== ADMIN_PASS) return alert("Wrong password!");

            const category = getSelectedCategory();
            if (!category) return alert("Please select or enter a category!");

            const formData = new FormData();
            formData.append("password", pass);
            formData.append("category", category);
            formData.append("name", document.getElementById("name").value.trim());
            formData.append("price", document.getElementById("price").value);
            formData.append("image", document.getElementById("image").files[0]);

            try {
                const res = await fetch("/api/admin/add-item", { method: "POST", body: formData });
                const data = await res.json();
                if (data.success) {
                    alert(`Item added to "${category}"!`);
                    loadCategories(); // Refresh dropdowns
                    document.getElementById("addForm").reset();
                    document.getElementById("newCategory").style.display = "none";
                } else {
                    alert("Error: " + (data.message || "Failed"));
                }
            } catch (err) {
                alert("Network error");
            }
        });

        async function loadItems(category) {
            if (!category) {
                document.getElementById("itemsList").innerHTML = "<p class='no-items'>Select a category</p>";
                return;
            }
            // ... (same loadItems, updatePrice, deleteItem functions as before)
            // Keep your existing loadItems code here
        }

        async function updatePrice(id) { /* your code */ }
        async function deleteItem(id) { /* your code */ }

        window.onload = loadCategories;
    </script>
</body>
</html>
