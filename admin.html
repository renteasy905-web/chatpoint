<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ChatPoint - Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <style>
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    font-family: 'Segoe UI', sans-serif;
    color: #333;
  }
  .card { border: none; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
  .btn-primary { background: #667eea; border: none; }
  .btn-success { background: #28a745; }
  .preview-img { width: 80px; height: 80px; object-fit: cover; border-radius: 10px; margin: 5px; border: 2px solid #667eea; }
  h1 { color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
  </style>
</head>
<body>
  <div class="container py-5">
    <h1 class="text-center mb-5"><i class="fas fa-crown"></i> ChatPoint Admin Panel</h1>

    <!-- Add New Shop -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h4><i class="fas fa-store"></i> Add New Shop</h4>
      </div>
      <div class="card-body">
        <form id="shopForm">
          <div class="row g-3">
            <div class="col-md-4">
              <input type="text" class="form-control" placeholder="Shop Name *" id="shopName" required>
            </div>
            <div class="col-md-4">
              <input type="text" class="form-control" placeholder="Owner Name" id="ownerName">
            </div>
            <div class="col-md-3">
              <input type="text" class="form-control" placeholder="Mobile" id="shopMobile">
            </div>
            <div class="col-12 col-md-1">
              <button type="submit" class="btn btn-primary w-100"><i class="fas fa-plus"></i></button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Add Item -->
    <div class="card">
      <div class="card-header bg-success text-white">
        <h4><i class="fas fa-utensils"></i> Add New Item</h4>
      </div>
      <div class="card-body">
        <form id="itemForm" enctype="multipart/form-data">
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <select class="form-select" id="shopSelect" required>
                <option value="">Choose Shop *</option>
              </select>
            </div>
            <div class="col-md-3">
              <input type="text" class="form-control" placeholder="Item Name *" id="itemName" required>
            </div>
            <div class="col-md-2">
              <input type="number" class="form-control" placeholder="Price *" id="itemPrice" required>
            </div>
            <div class="col-md-2">
              <input type="text" class="form-control" placeholder="Description (optional)" id="itemDesc">
            </div>
            <div class="col-md-3">
              <input type="file" class="form-control" id="itemImages" accept="image/*" multiple>
              <small class="text-muted">Max 10 images</small>
            </div>
            <div class="col-12 col-md-1">
              <button type="submit" class="btn btn-success w-100">Add</button>
            </div>
          </div>

          <div id="imagePreview" class="mt-3"></div>
        </form>
      </div>
    </div>

    <!-- Success Message -->
    <div id="successAlert" class="alert alert-success mt-4 d-none" role="alert">
      <i class="fas fa-check-circle"></i> <span id="successMsg"></span>
    </div>
  </div>

  <script>
    const API = "" ; // works on same domain

    // Load shops
    async function loadShops() {
      const res = await fetch(API + "/api/shops");
      const data = await res.json();
      const select = document.getElementById("shopSelect");
      select.innerHTML = '<option value="">Choose Shop *</option>';
      data.shops.forEach(shop => {
        const opt = document.createElement("option");
        opt.value = shop._id;
        opt.textContent = shop.shopName;
        select.appendChild(opt);
      });
    }

    // Add Shop
    document.getElementById("shopForm").onsubmit = async (e) => {
      e.preventDefault();
      const shopName = document.getElementById("shopName").value.trim();
      if (!shopName) return alert("Shop name required!");

      const res = await fetch(API + "/api/admin/add-shop", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          shopName,
          ownerName: document.getElementById("ownerName").value,
          mobile: document.getElementById("shopMobile").value
        })
      });
      const json = await res.json();
      if (json.success) {
        showSuccess("Shop added successfully!");
        document.getElementById("shopForm").reset();
        loadShops();
      } else alert("Error: " + (json.message || "Failed"));
    };

    // Image Preview
    document.getElementById("itemImages").onchange = (e) => {
      const preview = document.getElementById("imagePreview");
      preview.innerHTML = "";
      [...e.target.files].forEach(file => {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.className = "preview-img";
        preview.appendChild(img);
      });
    };

    // Add Item
    document.getElementById("itemForm").onsubmit = async (e) => {
      e.preventDefault();
      const shopId = document.getElementById("shopSelect").value;
      const name = document.getElementById("itemName").value.trim();
      const price = document.getElementById("itemPrice").value;
      if (!shopId || !name || !price) return alert("Fill all required fields!");

      const formData = new FormData();
      formData.append("shopId", shopId);
      formData.append("name", name);
      formData.append("price", price);
      formData.append("description", document.getElementById("itemDesc").value);

      const files = document.getElementById("itemImages").files;
      for (let i = 0; i < files.length; i++) {
        formData.append("images", files[i]);
      }

      const res = await fetch(API + "/api/admin/add-item", {
        method: "POST",
        body: formData
      });
      const json = await res.json();
      if (json.success) {
        showSuccess("Item added successfully!");
        document.getElementById("itemForm").reset();
        document.getElementById("imagePreview").innerHTML = "";
      } else {
        alert("Error: " + (json.message || "Failed to add item"));
      }
    };

    function showSuccess(msg) {
      const alert = document.getElementById("successAlert");
      document.getElementById("successMsg").textContent = msg;
      alert.classList.remove("d-none");
      setTimeout(() => alert.classList.add("d-none"), 4000);
    }

    // Load shops on page load
    loadShops();
  </script>
</body>
</html>
