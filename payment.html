<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout | Chat Point</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <style>
        /* (Your full CSS from before - unchanged) */
        :root {
            --bg: #0a0a0a;
            --card: #111111;
            --border: #222222;
            --text: #e0e0e0;
            --muted: #888888;
            --accent: #00ff9d;
            --accent2: #ff2e63;
            --glow: 0 0 20px rgba(0, 255, 157, 0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        /* ... rest of your CSS ... */
    </style>
</head>
<body>
    <div class="container" id="mainContainer"></div>

    <script>
        const CART_KEY = "chatpoint_cart";
        const USER_KEY = "chatpoint_user";
        const API_BASE = "https://chatpoint1.onrender.com";

        const PRIMARY = "9632367397";
        const BACKUP  = "8088975913";

        function checkLogin() {
            const user = JSON.parse(localStorage.getItem(USER_KEY) || "null");
            if (!user?._id) {
                document.getElementById("mainContainer").innerHTML = `
                    <div style="text-align:center;padding:60px;color:#888">
                        <h3>Login Required</h3>
                        <p><a href="login.html" style="color:#00ff9d;font-weight:700">Go to Login</a></p>
                    </div>`;
                return null;
            }
            return user;
        }

        function renderForm(user) {
            // ... your renderForm code (unchanged) ...
        }

        function renderCart() {
            // ... your renderCart code (unchanged, with shopName and itemsArray) ...
            let shopName = "Chat Point";
            if (Object.keys(cart).length > 0) shopName = Object.keys(cart)[0];

            // ... rest unchanged ...

            window.tempOrderData = { itemsArray, overallTotal, deliveryCharge, grandTotal, shopName };
        }

        function validateForm() {
            // ... unchanged ...
        }

        async function placeOrder() {
            if (!validateForm()) return;

            if (document.querySelector('input[name="paymentMode"]:checked').value !== "COD") {
                alert("Online payment coming soon!");
                return;
            }

            const user = JSON.parse(localStorage.getItem(USER_KEY));
            const { itemsArray, overallTotal, deliveryCharge, grandTotal, shopName } = window.tempOrderData || { itemsArray: [], overallTotal: 0, deliveryCharge: 30, grandTotal: 0, shopName: "Chat Point" };

            if (itemsArray.length === 0) {
                document.getElementById("errorMsg").textContent = "Cart is empty!";
                return;
            }

            const name = document.getElementById("name").value.trim();
            const phone = document.getElementById("phone").value.trim();
            const address1 = document.getElementById("address1").value.trim();
            const address2 = document.getElementById("address2").value.trim();

            const btn = document.getElementById("placeOrderBtn");
            btn.disabled = true;
            btn.innerHTML = "Saving Order...";

            const orderData = {
                user: { name, phone },
                shop: shopName,
                items: itemsArray,
                totalAmount: grandTotal,
                deliveryCharge: deliveryCharge,
                address: {
                    name,
                    phone,
                    line1: address1,
                    line2: address2 || ""
                },
                paymentMethod: "cash",
                status: "pending",
                date: new Date().toISOString()
            };

            // ONLY add userId if it's a valid 24-char hex string (real ObjectId)
            if (user && user._id && typeof user._id === 'string' && /^[a-f0-9]{24}$/i.test(user._id)) {
                orderData.userId = user._id;
            }

            console.log("Sending to server:", orderData);

            let saveSuccess = false;

            try {
                const res = await fetch(`${API_BASE}/api/save-order`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(orderData)
                });

                const data = await res.json();
                console.log("Server response:", data);

                if (res.ok && data.success) {
                    saveSuccess = true;
                    document.getElementById("successMsg").innerHTML = "Order Saved Successfully!";
                } else {
                    throw new Error(data.message || "Validation failed");
                }
            } catch (err) {
                console.error("Save failed:", err);
                document.getElementById("errorMsg").textContent = "Server rejected order. Still sending via WhatsApp.";
                setTimeout(() => document.getElementById("errorMsg").textContent = "", 6000);
            }

            localStorage.removeItem(CART_KEY);

            let itemsList = "";
            itemsArray.forEach(it => itemsList += `${it.name} × ${it.quantity}\n`);

            const message = `Hello! New Order Received\n\n${itemsList}\nName: ${name}\nPhone: ${phone}\nAddress: ${address1}${address2 ? ', ' + address2 : ''}\nTotal: ₹${grandTotal} (${deliveryCharge === 0 ? 'Free Delivery' : '₹' + deliveryCharge + ' Delivery'})\n\nPlease confirm and deliver soon!`;
            const encoded = encodeURIComponent(message);

            document.getElementById("successMsg").innerHTML += " Opening WhatsApp...";

            setTimeout(() => window.open(`https://wa.me/91${PRIMARY}?text=${encoded}`, '_blank'), 800);
            setTimeout(() => window.open(`https://wa.me/91${BACKUP}?text=${encoded}`, '_blank'), 1800);
        }

        window.onload = () => {
            const user = checkLogin();
            if (user) renderForm(user);
        };
    </script>
</body>
</html>
