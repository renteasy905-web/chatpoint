<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout | Chat Point</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <style>
        :root {
            --bg: #f0f4f7;
            --card: #ffffff;
            --border: #e0e0e0;
            --text: #1a1a1a;
            --muted: #6b7280;
            --accent: #2874f0;
            --accent2: #f05454;
            --success: #10b981;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        .page-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Form Section */
        .checkout-form {
            background: var(--card);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-section-title {
            font-size: 17px;
            font-weight: 700;
            color: var(--accent);
            margin: 24px 0 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        label {
            display: block;
            margin-top: 16px;
            font-weight: 600;
            font-size: 14px;
            color: var(--muted);
        }

        input[type=text], input[type=tel] {
            width: 100%;
            padding: 14px 16px;
            margin-top: 8px;
            border-radius: 10px;
            border: 1.5px solid var(--border);
            background: #fdfdfd;
            font-size: 16px;
            transition: all 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(40, 116, 240, 0.15);
        }

        /* Payment Options */
        .radio-group {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .radio-option {
            flex: 1;
            min-width: 140px;
        }

        .radio-option input {
            display: none;
        }

        .radio-option label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .radio-option input:checked + label {
            background: #e6f1ff;
            border-color: var(--accent);
            color: var(--accent);
            font-weight: 700;
            box-shadow: 0 0 0 1px var(--accent);
        }

        /* Cart Summary */
        .cart-summary {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            padding: 20px;
            margin-top: 10px;
        }

        .cart-summary h3 {
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 16px;
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .shop-section {
            background: #f8f8f8;
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 16px;
            border: 1px solid #eee;
        }

        .shop-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .item-line {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 15px;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
            padding: 8px 0;
            font-size: 16px;
        }

        .grand-total-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 2px dashed var(--border);
        }

        .grand-total-line {
            display: flex;
            justify-content: space-between;
            font-weight: 800;
            font-size: 22px;
            color: var(--accent);
        }

        .grand-total-line span:last-child {
            font-size: 26px;
        }

        .surprise-msg {
            text-align: center;
            padding: 14px;
            background: #ecfdf5;
            color: #059669;
            border: 1.5px solid #10b981;
            border-radius: 12px;
            margin: 16px 0;
            font-weight: 700;
            font-size: 15px;
        }

        /* Messages */
        .error-msg, .success-msg {
            text-align: center;
            padding: 12px;
            border-radius: 10px;
            margin: 16px 0;
            font-weight: 600;
        }

        .error-msg { background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; }
        .success-msg { background: #ecfdf5; color: #059669; border: 1px solid #10b981; }

        /* Sticky Mobile Button */
        .mobile-sticky-btn {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px;
            background: white;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            border-top: 1px solid var(--border);
        }

        button.main-btn {
            width: 100%;
            padding: 16px;
            background: var(--accent);
            color: white;
            font-weight: 700;
            font-size: 18px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(40, 116, 240, 0.3);
        }

        button.main-btn:hover:not(:disabled) {
            background: #1e5fd4;
            transform: translateY(-2px);
        }

        button.main-btn:disabled {
            background: #93bbfc;
            cursor: not-allowed;
        }

        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #ffffff40;
            border-left-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Desktop Layout */
        @media (min-width: 768px) {
            .page-wrapper {
                flex-direction: row;
                padding: 24px;
                gap: 30px;
            }

            .checkout-form {
                flex: 1;
                max-width: 700px;
                padding: 30px;
            }

            .cart-summary {
                width: 380px;
                position: sticky;
                top: 24px;
                margin-top: 0;
            }

            .mobile-sticky-btn {
                display: none !important;
            }

            h2 { font-size: 28px; }
        }

        @media (max-width: 480px) {
            .radio-group {
                flex-direction: column;
            }
            .radio-option {
                min-width: auto;
            }
            .radio-option label {
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body>

    <div class="page-wrapper">
        <div class="checkout-form" id="mainContainer"></div>

        <div class="cart-summary" id="cartSummary">
            <h3><i class="fas fa-shopping-bag"></i> Order Summary</h3>
            <div id="cartItems"></div>
            <div id="surpriseMsg"></div>
            <div id="summaryTotals"></div>
        </div>
    </div>

    <!-- Sticky Mobile Button -->
    <div class="mobile-sticky-btn" id="mobileBtnContainer">
        <button class="main-btn" id="placeOrderMobile">
            <span>PAY ₹499</span>
        </button>
    </div>

    <script>
        const CART_KEY = "chatpoint_cart";
        const USER_KEY = "chatpoint_user";
        const API_BASE = window.location.origin;

        const $ = (id) => document.getElementById(id);

        function checkLogin() {
            const user = JSON.parse(localStorage.getItem(USER_KEY) || "null");
            if (!user?._id) {
                $("mainContainer").innerHTML = `
                    <div style="text-align:center;padding:80px 20px;color:var(--muted)">
                        <h2>Please Login First</h2>
                        <p style="margin-top:16px">
                            <a href="login.html" style="color:var(--accent);font-weight:700;text-decoration:none">
                                Go to Login
                            </a>
                        </p>
                    </div>`;
                $("cartSummary").style.display = "none";
                $("mobileBtnContainer").style.display = "none";
                return null;
            }
            return user;
        }

        function renderForm(user) {
            $("mainContainer").innerHTML = `
                <h2>Delivery Details</h2>

                <div class="form-section-title">Contact Information</div>
                <label>Full Name <span style="color:var(--accent2)">*</span></label>
                <input type="text" id="name" value="${user.name || ''}" placeholder="John Doe" required />

                <label>Phone Number <span style="color:var(--accent2)">*</span></label>
                <input type="tel" id="phone" value="${user.phone || ''}" placeholder="9876543210" maxlength="10" required />

                <div class="form-section-title">Delivery Address</div>
                <input type="text" id="address1" placeholder="House no., Building, Street *" required />
                <input type="text" id="address2" placeholder="Landmark (optional)" style="margin-top:12px" />

                <div class="form-section-title">Payment Method</div>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" name="payment" id="cod" value="COD" checked />
                        <label for="cod">Cash on Delivery</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" name="payment" id="online" value="Online" disabled />
                        <label for="online">Pay Online (Soon)</label>
                    </div>
                </div>

                <div id="errorMsg" class="error-msg"></div>
                <div id="successMsg" class="success-msg"></div>

                <!-- Desktop Button -->
                <button class="main-btn" id="placeOrderDesktop" style="margin-top:24px;display:none">
                    PLACE ORDER
                </button>
            `;

            // Show desktop button only on large screens
            if (window.innerWidth >= 768) {
                $("placeOrderDesktop").style.display = "block";
            }

            renderCart();
            $("placeOrderMobile").onclick = placeOrder;
            $("placeOrderDesktop")?.addEventListener("click", placeOrder);
        }

        function renderCart() {
            const cart = JSON.parse(localStorage.getItem(CART_KEY) || "{}");
            let total = 0;
            let html = "";

            for (const shop in cart) {
                let shopTotal = 0;
                let items = "";

                for (const item in cart[shop]) {
                    const it = cart[shop][item];
                    if (it.qty > 0) {
                        const amt = it.price * it.qty;
                        shopTotal += amt;
                        items += `<div class="item-line"><span>${item} × ${it.qty}</span><span>₹${amt}</span></div>`;
                    }
                }

                if (shopTotal > 0) {
                    html += `
                        <div class="shop-section">
                            <div class="shop-title">${shop}</div>
                            ${items}
                            <div class="total-line" style="border-top:1px solid #ddd;padding-top:8px">
                                <span>Subtotal</span><span>₹${shopTotal}</span>
                            </div>
                        </div>`;
                    total += shopTotal;
                }
            }

            const delivery = total >= 50 ? 0 : 30;
            const grandTotal = total + delivery;

            $("cartItems").innerHTML = html || `<p style="text-align:center;color:var(--muted);padding:30px">Your cart is empty</p>`;
            $("surpriseMsg").innerHTML = total >= 50 && total > 0 ? 
                `<div class="surprise-msg">FREE DELIVERY UNLOCKED!</div>` : "";

            $("summaryTotals").innerHTML = `
                <div class="grand-total-section">
                    <div class="total-line"><span>Items Total</span><span>₹${total}</span></div>
                    <div class="total-line"><span>Delivery</span>
                        <span style="color:${delivery===0?'var(--success)':'inherit'};font-weight:700">
                            ${delivery===0 ? 'FREE!' : '₹'+delivery}
                        </span>
                    </div>
                    <div class="grand-total-line">
                        <span>Grand Total</span><span>₹${grandTotal}</span>
                    </div>
                </div>
            `;

            // Update both buttons
            const btnText = `PAY ₹${grandTotal}`;
            $("placeOrderMobile").innerHTML = `<span>${btnText}</span>`;
            const deskBtn = $("placeOrderDesktop");
            if (deskBtn) deskBtn.innerHTML = btnText;

            const empty = total === 0;
            $("placeOrderMobile").disabled = empty;
            if (deskBtn) deskBtn.disabled = empty;
        }

        function validate() {
            const name = $("name").value.trim();
            const phone = $("phone").value.trim();
            const addr = $("address1").value.trim();

            if (!name || !phone || !addr) return "Please fill all required fields";
            if (!/^\d{10}$/.test(phone)) return "Enter valid 10-digit phone number";
            return null;
        }

        async function placeOrder() {
            const err = validate();
            if (err) return $("errorMsg").textContent = err;

            if (document.querySelector('input[name="payment"]:checked').value !== "COD") {
                $("errorMsg").textContent = "Online payment coming soon! Using COD.";
                document.getElementById("cod").checked = true;
                return;
            }

            const btns = [$("placeOrderMobile"), $("placeOrderDesktop")].filter(Boolean);
            btns.forEach(b => {
                b.disabled = true;
                b.innerHTML = `<div class="spinner"></div> Placing Order...`;
            });

            // Simulate API
            await new Promise(r => setTimeout(r, 1500));

            localStorage.removeItem(CART_KEY);
            $("successMsg").innerHTML = `Order Placed Successfully!<br><small>Redirecting...</small>`;
            $("errorMsg").textContent = "";

            setTimeout(() => location.href = "orders.html", 2000);
        }

        // Init
        window.onload = () => {
            const user = checkLogin();
            if (user) renderForm(user);
        };

        window.onresize = renderCart;
    </script>
</body>
</html>
