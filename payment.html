<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout | Chat Point</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <style>
    :root { --bg: #0a0a0a; --card: #111111; --accent: #00ff9d; --accent2: #ff2e63; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Outfit', sans-serif; background: var(--bg); color: #e0e0e0; min-height: 100vh; }
    .container { max-width: 480px; margin: 20px auto; padding: 24px; background: var(--card); border-radius: 24px; border: 1px solid #333; }
    h2 { font-size: 28px; font-weight: 800; text-align: center; background: linear-gradient(90deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 24px; }
    input { width: 100%; padding: 14px; margin: 8px 0; border-radius: 16px; border: 1px solid #333; background: #1a1a1a; color: white; }
    button { margin-top: 32px; width: 100%; padding: 18px; background: linear-gradient(90deg, var(--accent), var(--accent2)); color: black; font-weight: 800; font-size: 18px; border: none; border-radius: 20px; cursor: pointer; }
    .success { color: var(--accent); text-align: center; font-size: 20px; margin: 20px 0; }
  </style>
</head>
<body>
  <div class="container" id="mainContainer"></div>

  <script>
    const CART_KEY = "chatpoint_cart";
    const USER_KEY = "chatpoint_user";
    const API_BASE = window.location.origin;

    // YOUR NUMBERS — FIRST ONE WILL OPEN FIRST
    const PRIMARY   = "9632367397";   // ← Opens first
    const BACKUP    = "8088975913";   // ← Opens second

    window.onload = () => {
      const user = JSON.parse(localStorage.getItem(USER_KEY) || "null");
      if (!user?._id) return document.body.innerHTML = `<div style="text-align:center;padding:100px"><h3>Login Required</h3><a href="login.html" style="color:#00ff9d">Go to Login</a></div>`;
      renderForm(user);
    };

    function renderForm(user) {
      document.getElementById("mainContainer").innerHTML = `
        <h2>Secure Checkout</h2>
        <input type="text" id="name" placeholder="Full Name *" value="${user.name||''}" required />
        <input type="tel" id="phone" placeholder="Phone Number *" value="${user.phone||''}" required />
        <input type="text" id="address1" placeholder="Full Address *" required />
        <input type="text" id="address2" placeholder="Landmark (optional)" />
        <div id="cartContainer" style="margin:28px 0"></div>
        <button id="placeOrderBtn">PLACE ORDER NOW</button>
        <div id="status" class="success"></div>
      `;
      renderCart();
      document.getElementById("placeOrderBtn").onclick = placeOrder;
    }

    function renderCart() {
      const cart = JSON.parse(localStorage.getItem(CART_KEY) || "{}");
      let html = "", total = 0;
      for (const shop in cart) {
        for (const item in cart[shop]) {
          const it = cart[shop][item];
          if (it.qty > 0) {
            html += `<div style="padding:8px 0;border-bottom:1px dashed #333"><strong>${item}</strong> × ${it.qty} — ₹${it.price*it.qty}</div>`;
            total += it.price * it.qty;
          }
        }
      }
      const del = total >= 50 ? 0 : 30;
      html += `<div style="margin-top:15px;font-size:18px"><strong>Total: ₹${total + del} (${del===0?'Free':del} delivery)</strong></div>`;
      document.getElementById("cartContainer").innerHTML = html;
    }

    async function placeOrder() {
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const address1 = document.getElementById("address1").value.trim();
      const address2 = document.getElementById("address2").value.trim();

      if (!name || !phone || !address1 || !/^\d{10}$/.test(phone)) {
        alert("Please fill all fields correctly");
        return;
      }

      const btn = document.getElementById("placeOrderBtn");
      btn.disabled = true;
      btn.textContent = "Saving Order...";

      // Save to your backend (keeps working even if WhatsApp fails)
      try {
        const cart = JSON.parse(localStorage.getItem(CART_KEY) || "{}");
        await fetch(`${API_BASE}/api/save-order`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: JSON.parse(localStorage.getItem(USER_KEY))._id, name, phone, address1, address2, cart, paymentMode: "cash" })
        });
        localStorage.removeItem(CART_KEY);
      } catch(e) {}

      // Build order text
      const cart = JSON.parse(localStorage.getItem(CART_KEY) || "{}");
      let items = "";
      let total = 0;
      for (const shop in cart) {
        for (const item in cart[shop]) {
          const it = cart[shop][item];
          if (it.qty > 0) {
            items += `${item} (${shop}) × ${it.qty}\n`;
            total += it.price * it.qty;
          }
        }
      }
      const del = total >= 50 ? 0 : 30;
      const message = `Hello! I have an order\n\n${items}\nName: ${name}\nPhone: ${phone}\nAddress: ${address1}${address2?', '+address2:''}\nTotal: ₹${total+del} (${del===0?'Free Delivery':'₹'+del+' Delivery'})\n\nKindly accept my order and reach us fast!`;

      const encoded = encodeURIComponent(message);

      document.getElementById("status").innerHTML = "Order placed! Opening WhatsApp...";

      // OPEN WHATSAPP AUTOMATICALLY — FIRST PRIMARY, THEN BACKUP
      setTimeout(() => window.location.href = `https://wa.me/91${PRIMARY}?text=${encoded}`, 500);
      setTimeout(() => window.location.href = `https://wa.me/91${BACKUP}?text=${encoded}`, 1500);

      // Final success message
      setTimeout(() => {
        document.getElementById("status").innerHTML = "Order Sent! Thank you ❤️<br><small>You can close this page</small>";
      }, 3000);
    }
  </script>
</body>
</html>
