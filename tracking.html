<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders & Tracking | ChatPoint</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background:#f8f8f8;
            margin:0;
            padding:0;
        }
        .header {
            position:sticky; top:0; background:white; padding:15px;
            box-shadow:0 2px 10px rgba(0,0,0,0.1); display:flex; align-items:center; gap:15px; z-index:10;
        }
        .back { font-size:28px; cursor:pointer; color:#4CAF50; }
        .title { font-size:20px; font-weight:bold; flex:1; }
        .container { padding:20px; max-width:600px; margin:0 auto; }
        .order-card {
            background:white; border-radius:12px; margin:16px 0; overflow:hidden;
            box-shadow:0 4px 10px rgba(0,0,0,0.08);
        }
        .order-header {
            padding:16px; border-bottom:1px solid #eee;
            display:flex; justify-content:space-between; align-items:center;
        }
        .order-id { font-weight:bold; font-size:1.1rem; }
        .order-status { font-size:0.9rem; color:#4CAF50; }
        .status-pending { color:#e67e22; }
        .status-delivered { color:#27ae60; }
        .status-cancelled { color:#c0392b; }
        /* Items List */
        .items-section {
            padding:20px; background:#f9f9f9;
        }
        .item-row {
            display:flex; align-items:center; gap:16px;
            padding:12px 0; border-bottom:1px solid #eee;
        }
        .item-row:last-child { border-bottom:none; }
        .item-img { width:60px; height:60px; object-fit:cover; border-radius:8px; }
        .item-info { flex:1; }
        .item-name { font-weight:600; font-size:16px; }
        .item-details { color:#666; font-size:14px; margin-top:4px; }
        .item-price { color:#4CAF50; font-weight:bold; font-size:16px; }
        /* Buttons */
        .track-btn, .pay-btn {
            width:100%; background:#4CAF50; color:white; border:none;
            padding:16px; font-size:18px; font-weight:bold; border-radius:0;
            cursor:pointer;
        }
        .pay-btn {
            background:#6f42c1; /* PhonePe purple */
        }
        .pay-btn:hover { background:#5a32a3; }
        .track-btn:disabled { background:#ccc; cursor:not-allowed; }
        .tracking-section { display:none; }
        .tracking-section.active { display:block; }
        .map-container {
            position:relative; height:300px; background:#e0e0e0; overflow:hidden;
        }
        .map-bg { width:100%; height:100%; object-fit:cover; filter:brightness(0.9); }
        .path { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
        .path-svg { width:100%; height:100%; }
        .dotted-line { stroke:#ff4500; stroke-width:4; fill:none; stroke-dasharray:8,8; }
        .pin { position:absolute; font-size:32px; color:#ff4500; transform:translate(-50%,-100%); }
        .store-pin { left:15%; top:70%; }
        .customer-pin { left:80%; top:20%; }
        .bike {
            position:absolute; font-size:28px; color:black;
            transform:translate(-50%,-50%); transition:all 1s ease-in-out; z-index:5;
        }
        .status-box { text-align:center; padding:20px; background:white; }
        .status-title { font-size:18px; font-weight:bold; color:#333; }
        .eta { font-size:16px; color:#ff4500; font-weight:bold; margin:10px 0; }
        .progress-steps {
            display:flex; justify-content:space-between; padding:20px;
        }
        .step { text-align:center; flex:1; }
        .step-circle {
            width:40px; height:40px; border-radius:50%; background:#ddd;
            margin:0 auto 8px; display:flex; align-items:center; justify-content:center;
            color:white; font-weight:bold;
        }
        .step.active .step-circle { background:#ff4500; }
        .step-label { font-size:12px; color:#666; }
        .step.active .step-label { color:#ff4500; font-weight:bold; }
        .no-login, .no-orders {
            text-align:center; padding:80px 20px; color:#e74c3c; font-size:18px;
        }
        .no-login a, .no-orders a { color:#4CAF50; font-weight:bold; text-decoration:none; }
        .loader { text-align:center; padding:60px; color:#888; }
    </style>
</head>
<body>
    <div class="header">
        <div class="back" onclick="history.back()">‚Üê</div>
        <div class="title">My Orders & Tracking</div>
    </div>
    <div class="container">
        <div id="loading" class="loader">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <p>Loading your orders...</p>
        </div>
        <div id="noLogin" class="no-login" style="display:none;">
            <p>You need to login to view your orders</p>
            <p><a href="login.html">Login Now ‚Üí</a></p>
        </div>
        <div id="noOrders" class="no-orders" style="display:none;">
            <p>No orders found</p>
            <p><a href="index.html">Start Shopping ‚Üí</a></p>
        </div>
        <div id="ordersList"></div>
    </div>

    <script>
        const loggedUser = JSON.parse(localStorage.getItem('chatpoint_user') || 'null');

        if (!loggedUser) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('noLogin').style.display = 'block';
        } else {
            fetchUserOrders();
            setInterval(fetchUserOrders, 10000); // Refresh every 10 seconds
        }

        async function fetchUserOrders() {
            try {
                const res = await fetch("/api/my-orders", {
                    headers: { 'x-user-id': loggedUser._id }
                });
                const data = await res.json();
                if (data.success && data.orders && data.orders.length > 0) {
                    renderOrders(data.orders);
                } else {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('noOrders').style.display = 'block';
                }
            } catch (err) {
                console.error(err);
                document.getElementById('loading').innerHTML = '<p>Error loading orders. Retrying...</p>';
            }
        }

        function payWithPhonePe(amount, orderId) {
            const upiID = '9632367397@ybl';
            const payeeName = encodeURIComponent('ChatPoint');
            const transactionNote = encodeURIComponent(`ChatPoint Order #${orderId.slice(-6)} Payment`);
            const transactionRef = 'CHAT' + Date.now();
            const phonepeLink = `phonepe://pay?pa=${upiID}&pn=${payeeName}&am=${amount}&tn=${transactionNote}&tr=${transactionRef}&cu=INR`;
            window.location.href = phonepeLink;
            setTimeout(() => {
                if (confirm('PhonePe not opened? Try with any UPI app?')) {
                    const genericLink = `upi://pay?pa=${upiID}&pn=${payeeName}&am=${amount}&tn=${transactionNote}&tr=${transactionRef}&cu=INR`;
                    window.location.href = genericLink;
                }
            }, 2000);
        }

        // Flexible function to get items HTML from different possible structures
        function getItemsHtml(order) {
            let items = [];

            // 1. Most common: order.items as array
            if (Array.isArray(order.items)) {
                items = order.items;
            }
            // 2. Sometimes called products
            else if (Array.isArray(order.products)) {
                items = order.products;
            }
            // 3. Nested cart
            else if (order.cart) {
                if (Array.isArray(order.cart.items)) {
                    items = order.cart.items;
                } else if (Array.isArray(order.cart.products)) {
                    items = order.cart.products;
                }
                // 4. Your old format: order.cart.ChatPoint = { "Item Name": {qty, price}, ... }
                else if (order.cart.ChatPoint && typeof order.cart.ChatPoint === 'object') {
                    return Object.entries(order.cart.ChatPoint).map(([name, item]) => {
                        const qty = item.qty || 1;
                        const price = item.price || 0;
                        return `
                            <div class="item-row">
                                <div class="item-info">
                                    <div class="item-name">${name}</div>
                                    <div class="item-details">Quantity: ${qty}</div>
                                </div>
                                <div class="item-price">‚Çπ${(price * qty).toFixed(0)}</div>
                            </div>
                        `;
                    }).join('');
                }
            }

            // If we have array of items
            if (items.length > 0) {
                return items.map(item => {
                    const name = item.name || item.title || item.productName || 'Item';
                    const qty = item.qty || item.quantity || 1;
                    const price = item.price || item.unitPrice || item.discountedPrice || 0;
                    return `
                        <div class="item-row">
                            <div class="item-info">
                                <div class="item-name">${name}</div>
                                <div class="item-details">Quantity: ${qty}</div>
                            </div>
                            <div class="item-price">‚Çπ${(price * qty).toFixed(0)}</div>
                        </div>
                    `;
                }).join('');
            }

            return '<div style="text-align:center;color:#888;padding:20px;">No items found in this order</div>';
        }

        function renderOrders(orders) {
            document.getElementById('loading').style.display = 'none';
            const list = document.getElementById('ordersList');

            list.innerHTML = orders.map(order => {
                const progress = order.progress || 0;
                const isTrackable = order.status === 'confirmed' || order.status === 'out_for_delivery' || order.status === 'delivered';
                const shortId = order._id.slice(-6);

                const positions = [
                    { left: '15%', top: '70%' },
                    { left: '35%', top: '55%' },
                    { left: '55%', top: '45%' },
                    { left: '70%', top: '30%' },
                    { left: '80%', top: '20%' }
                ];
                const pos = positions[Math.min(progress, 4)];

                const messages = [
                    "Order confirmed - being prepared",
                    "Picked up from store",
                    "On the way",
                    "Almost there!",
                    "Delivered! Enjoy ü•≥"
                ];
                const etas = ["~30 min", "~25 min", "~15 min", "~5 min", "Delivered"];

                let bikeIcon = '<i class="fas fa-motorcycle"></i>';
                if (progress === 4) bikeIcon = '<i class="fas fa-check-circle" style="font-size:36px;color:#27ae60;"></i>';

                let statusClass = `status-${order.status}`;
                let statusText = order.status.charAt(0).toUpperCase() + order.status.slice(1);

                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div class="order-id">Order #${shortId}</div>
                            <div class="order-status ${statusClass}">${statusText}</div>
                        </div>
                        <!-- Items List - NOW WORKING -->
                        <div class="items-section">
                            <h3 style="margin:0 0 16px 0; color:#333;">Your Items</h3>
                            ${getItemsHtml(order)}
                        </div>
                        <!-- Pay Now Button for Pending Orders -->
                        ${order.status === 'pending' ? `
                            <button class="pay-btn" onclick="payWithPhonePe(${order.grandTotal}, '${order._id}')">
                                Pay Now ‚Çπ${order.grandTotal} via PhonePe
                            </button>
                        ` : ''}
                        <!-- Pending Message -->
                        ${order.status === 'pending' ? `
                            <div style="padding:20px; text-align:center; background:#fff9e6; color:#e67e22; font-size:16px;">
                                ‚è≥ Waiting for shop confirmation
                            </div>
                        ` : ''}
                        <!-- Tracking Section -->
                        ${isTrackable ? `
                            <button class="track-btn" onclick="toggleTracking(this)">Track Order</button>
                            <div class="tracking-section">
                                <div class="map-container">
                                    <img src="https://images.unsplash.com/photo-1569336415965-7d80c2e3ff2a?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80" alt="Map" class="map-bg">
                                    <div class="path">
                                        <svg class="path-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
                                            <path class="dotted-line" d="M15 70 Q 30 50, 50 45 T 80 20" />
                                        </svg>
                                    </div>
                                    <div class="pin store-pin"><i class="fas fa-store"></i></div>
                                    <div class="pin customer-pin"><i class="fas fa-map-marker-alt"></i></div>
                                    <div class="bike" style="left:${pos.left};top:${pos.top};">${bikeIcon}</div>
                                </div>
                                <div class="status-box">
                                    <div class="status-title">${messages[progress] || 'On the way'}</div>
                                    <div class="eta">${etas[progress] || '~15 min'}</div>
                                    <div class="progress-steps">
                                        ${[1,2,3,4].map(num => `
                                            <div class="step ${progress >= num ? 'active' : ''}">
                                                <div class="step-circle">${num}</div>
                                                <div class="step-label">${['Prepared','Picked','On Way','Delivered'][num-1]}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>`;
            }).join('');
        }

        function toggleTracking(btn) {
            const section = btn.nextElementSibling;
            if (section && section.classList.contains('tracking-section')) {
                section.classList.toggle('active');
            }
        }
    </script>
</body>
</html>
